<app-header></app-header>

<div class="settings-container">
  <div class="settings-header">
    <h1>Settings</h1>
    <p class="settings-subtitle">Manage your account settings and preferences</p>
  </div>

  @if (currentUser()) {
    <!-- Account Information Section -->
    <div class="settings-section">
      <div class="section-header">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
          <circle cx="12" cy="7" r="4"/>
        </svg>
        <div>
          <h2>Account Information</h2>
          <p>Your account details</p>
        </div>
      </div>
      
      <div class="info-grid">
        <div class="info-item">
          <label>Name</label>
          <div class="info-value">{{ currentUser()!.name }}</div>
        </div>
        <div class="info-item">
          <label>Email</label>
          <div class="info-value">{{ currentUser()!.email }}</div>
        </div>
        <div class="info-item">
          <label>Member Since</label>
          <div class="info-value">{{ formatDate(currentUser()!.createdAt) }}</div>
        </div>
      </div>
    </div>

    <!-- Update Password Section -->
    <div class="settings-section">
      <div class="section-header">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
          <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
        </svg>
        <div>
          <h2>Update Password</h2>
          <p>Change your password to keep your account secure</p>
        </div>
      </div>

      @if (passwordMessage()) {
        <div class="message" [class.success]="passwordMessage()!.type === 'success'" [class.error]="passwordMessage()!.type === 'error'">
          {{ passwordMessage()!.text }}
        </div>
      }

      <form [formGroup]="passwordForm" (ngSubmit)="onUpdatePassword()">
        <div class="form-group">
          <label for="currentPassword">Current Password</label>
          <input 
            type="password" 
            id="currentPassword" 
            formControlName="currentPassword"
            [class.invalid]="passwordForm.get('currentPassword')?.invalid && passwordForm.get('currentPassword')?.touched"
          />
          @if (passwordForm.get('currentPassword')?.invalid && passwordForm.get('currentPassword')?.touched) {
            <span class="error-text">Current password is required (min 6 characters)</span>
          }
        </div>

        <div class="form-group">
          <label for="newPassword">New Password</label>
          <input 
            type="password" 
            id="newPassword" 
            formControlName="newPassword"
            [class.invalid]="passwordForm.get('newPassword')?.invalid && passwordForm.get('newPassword')?.touched"
          />
          @if (passwordForm.get('newPassword')?.invalid && passwordForm.get('newPassword')?.touched) {
            <span class="error-text">New password is required (min 6 characters)</span>
          }
        </div>

        <div class="form-group">
          <label for="confirmPassword">Confirm New Password</label>
          <input 
            type="password" 
            id="confirmPassword" 
            formControlName="confirmPassword"
            [class.invalid]="(passwordForm.get('confirmPassword')?.invalid || passwordForm.errors?.['passwordMismatch']) && passwordForm.get('confirmPassword')?.touched"
          />
          @if (passwordForm.errors?.['passwordMismatch'] && passwordForm.get('confirmPassword')?.touched) {
            <span class="error-text">Passwords do not match</span>
          }
        </div>

        <button 
          type="submit" 
          class="btn-primary" 
          [disabled]="isUpdatingPassword()"
        >
          @if (isUpdatingPassword()) {
            <span>Updating...</span>
          } @else {
            <span>Update Password</span>
          }
        </button>
      </form>
    </div>

    <!-- Update Email Section -->
    <div class="settings-section">
      <div class="section-header">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
          <polyline points="22,6 12,13 2,6"/>
        </svg>
        <div>
          <h2>Update Email</h2>
          <p>Change your email address</p>
        </div>
      </div>

      @if (emailMessage()) {
        <div class="message" [class.success]="emailMessage()!.type === 'success'" [class.error]="emailMessage()!.type === 'error'">
          {{ emailMessage()!.text }}
        </div>
      }

      <form [formGroup]="emailForm" (ngSubmit)="onUpdateEmail()">
        <div class="form-group">
          <label for="newEmail">New Email Address</label>
          <input 
            type="email" 
            id="newEmail" 
            formControlName="newEmail"
            [class.invalid]="emailForm.get('newEmail')?.invalid && emailForm.get('newEmail')?.touched"
          />
          @if (emailForm.get('newEmail')?.invalid && emailForm.get('newEmail')?.touched) {
            <span class="error-text">Please enter a valid email address</span>
          }
        </div>

        <div class="form-group">
          <label for="emailPassword">Confirm Password</label>
          <input 
            type="password" 
            id="emailPassword" 
            formControlName="password"
            [class.invalid]="emailForm.get('password')?.invalid && emailForm.get('password')?.touched"
          />
          @if (emailForm.get('password')?.invalid && emailForm.get('password')?.touched) {
            <span class="error-text">Password is required</span>
          }
        </div>

        <button 
          type="submit" 
          class="btn-primary" 
          [disabled]="isUpdatingEmail()"
        >
          @if (isUpdatingEmail()) {
            <span>Updating...</span>
          } @else {
            <span>Update Email</span>
          }
        </button>
      </form>
    </div>

    <!-- Timer Notification Sound Section -->
    <div class="settings-section">
      <div class="section-header">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 2v4"/>
          <path d="m16.24 7.76-2.12 2.12"/>
          <circle cx="12" cy="12" r="2"/>
          <path d="M6.34 7.76 4.22 5.64"/>
          <path d="M2 12h4"/>
          <path d="m4.22 18.36 2.12-2.12"/>
          <path d="M12 18v4"/>
          <path d="m17.76 16.24 2.12 2.12"/>
          <path d="M22 12h-4"/>
        </svg>
        <div>
          <h2>Timer Notification Sound</h2>
          <p>Choose the sound that plays when your timer completes</p>
        </div>
      </div>

      <div class="sound-options">
        <div class="sound-category">
          <h3 class="category-title">Chimes</h3>
          @for (sound of getSoundsByCategory('chime'); track sound.id) {
            <div class="sound-option">
              <label class="sound-label">
                <input 
                  type="radio" 
                  name="timerSound" 
                  [value]="sound.id"
                  [checked]="selectedSound() === sound.id"
                  (change)="onSoundChange(sound.id)"
                />
                <div class="sound-info">
                  <div class="sound-name">{{ sound.name }}</div>
                  <div class="sound-description">{{ sound.description }}</div>
                </div>
              </label>
              <button 
                type="button" 
                class="btn-preview" 
                (click)="onPreviewSound(sound.id)"
                title="Preview sound"
              >
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M8 5v14l11-7z"/>
                </svg>
                Preview
              </button>
            </div>
          }
        </div>

        <div class="sound-category">
          <h3 class="category-title">Notifications</h3>
          @for (sound of getSoundsByCategory('notification'); track sound.id) {
            <div class="sound-option">
              <label class="sound-label">
                <input 
                  type="radio" 
                  name="timerSound" 
                  [value]="sound.id"
                  [checked]="selectedSound() === sound.id"
                  (change)="onSoundChange(sound.id)"
                />
                <div class="sound-info">
                  <div class="sound-name">{{ sound.name }}</div>
                  <div class="sound-description">{{ sound.description }}</div>
                </div>
              </label>
              <button 
                type="button" 
                class="btn-preview" 
                (click)="onPreviewSound(sound.id)"
                title="Preview sound"
              >
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M8 5v14l11-7z"/>
                </svg>
                Preview
              </button>
            </div>
          }
        </div>
      </div>
    </div>

    <!-- Danger Zone Section -->
    <div class="settings-section danger-zone">
      <div class="section-header">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
          <line x1="12" y1="9" x2="12" y2="13"/>
          <line x1="12" y1="17" x2="12.01" y2="17"/>
        </svg>
        <div>
          <h2>Danger Zone</h2>
          <p>Irreversible actions</p>
        </div>
      </div>

      <div class="danger-actions">
        <div class="danger-item">
          <div class="danger-info">
            <h3>Logout</h3>
            <p>Sign out of your account</p>
          </div>
          <button class="btn-secondary" (click)="onLogout()">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
              <polyline points="16 17 21 12 16 7"/>
              <line x1="21" y1="12" x2="9" y2="12"/>
            </svg>
            Logout
          </button>
        </div>

        <div class="divider"></div>

        <div class="danger-item">
          <div class="danger-info">
            <h3>Delete Account</h3>
            <p>Permanently delete your account and all associated data. This action cannot be undone.</p>
          </div>
        </div>

        <form [formGroup]="deleteForm" (ngSubmit)="onDeleteAccount()">
          <div class="form-group">
            <label for="deletePassword">Confirm Password</label>
            <input 
              type="password" 
              id="deletePassword" 
              formControlName="password"
              [class.invalid]="deleteForm.get('password')?.invalid && deleteForm.get('password')?.touched"
            />
          </div>

          <div class="form-group">
            <label for="confirmationText">Type <strong>DELETE</strong> to confirm</label>
            <input 
              type="text" 
              id="confirmationText" 
              formControlName="confirmationText"
              placeholder="DELETE"
              [class.invalid]="deleteForm.get('confirmationText')?.invalid && deleteForm.get('confirmationText')?.touched"
            />
          </div>

          <button 
            type="submit" 
            class="btn-danger" 
            [disabled]="isDeletingAccount()"
          >
            @if (isDeletingAccount()) {
              <span>Deleting Account...</span>
            } @else {
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="3 6 5 6 21 6"/>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
              </svg>
              <span>Delete My Account</span>
            }
          </button>
        </form>
      </div>
    </div>
  }
</div>

